{% extends "base.html" %}
{% load static %}

{% block content %}
<div style="display: flex; height: calc(100vh - 70px);">
    <div style="width: 350px; background: white; border-right: 1px solid #ddd; padding: 20px; overflow-y: auto;">
        <h3 style="color: #5e72e4; margin-bottom: 5px;">ğŸš€ Tá»‘i Æ°u Lá»™ trÃ¬nh</h3>
        <p style="font-size: 13px; color: #888;">Thuáº­t toÃ¡n: Nearest Neighbor (TSP)</p>
        <hr>
        
        <button onclick="optimizeRoute()" style="width: 100%; padding: 10px; background: #2dce89; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 20px;">
            âš¡ Cháº¡y Tá»‘i Æ¯u HÃ³a Ngay
        </button>

        <div id="route-list">
            <p style="text-align: center; color: #888; margin-top: 50px;">
                Nháº¥n nÃºt bÃªn trÃªn Ä‘á»ƒ há»‡ thá»‘ng <br>tÃ­nh toÃ¡n Ä‘Æ°á»ng Ä‘i ngáº¯n nháº¥t.
            </p>
        </div>
    </div>

    <div style="flex: 1; position: relative;">
        <div id="map" style="width: 100%; height: 100%;"></div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
    // 1. Dá»¯ liá»‡u Ä‘áº§u vÃ o (Tá»« Django)
    var warehouse = {lat: 10.7721, lng: 106.6983, name: "KHO TRUNG TÃ‚M"};
    var customers = [
        {% for dh in ds_don %}
        {
            id: "{{ dh.ma_don }}",
            name: "{{ dh.ten_nguoi_nhan }}",
            lat: parseFloat("{{ dh.lat_khach }}".replace(',', '.')),
            lng: parseFloat("{{ dh.lng_khach }}".replace(',', '.')),
            address: "{{ dh.dia_chi_nguoi_nhan }}"
        },
        {% endfor %}
    ];

    // 2. Khá»Ÿi táº¡o báº£n Ä‘á»“
    var map = L.map('map').setView([warehouse.lat, warehouse.lng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© Logistics Pro' }).addTo(map);

    // Icon
    var warehouseIcon = L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/2821/2821861.png', iconSize: [40, 40], iconAnchor: [20, 40]});
    var customerIcon = L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/3097/3097144.png', iconSize: [35, 35], iconAnchor: [17, 35]});

    // Váº½ kho trÆ°á»›c
    L.marker([warehouse.lat, warehouse.lng], {icon: warehouseIcon}).addTo(map).bindPopup("<b>ğŸš© KHO XUáº¤T PHÃT</b>");

    // Biáº¿n lÆ°u control Ä‘Æ°á»ng Ä‘i
    var routingControl = null;

    // --- THUáº¬T TOÃN Tá»I Æ¯U HÃ“A (NEAREST NEIGHBOR) ---
    function optimizeRoute() {
        // Náº¿u khÃ´ng cÃ³ khÃ¡ch thÃ¬ thÃ´i
        if (customers.length === 0) { alert("KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng Ä‘á»ƒ tá»‘i Æ°u!"); return; }

        var unvisited = [...customers]; // Copy danh sÃ¡ch khÃ¡ch
        var currentLocation = warehouse; // Báº¯t Ä‘áº§u tá»« kho
        var optimizedPath = [L.latLng(warehouse.lat, warehouse.lng)]; // Danh sÃ¡ch Ä‘iá»ƒm Ä‘i
        var htmlList = "";

        // Thuáº­t toÃ¡n: TÃ¬m Ä‘iá»ƒm gáº§n nháº¥t tiáº¿p theo
        while (unvisited.length > 0) {
            var nearestIndex = -1;
            var minDistance = Infinity;

            for (var i = 0; i < unvisited.length; i++) {
                // TÃ­nh khoáº£ng cÃ¡ch chim bay (Euclidean)
                var d = Math.sqrt(
                    Math.pow(unvisited[i].lat - currentLocation.lat, 2) + 
                    Math.pow(unvisited[i].lng - currentLocation.lng, 2)
                );

                if (d < minDistance) {
                    minDistance = d;
                    nearestIndex = i;
                }
            }

            // ÄÃ£ tÃ¬m tháº¥y khÃ¡ch gáº§n nháº¥t
            var nextStop = unvisited[nearestIndex];
            
            // ThÃªm vÃ o lá»™ trÃ¬nh
            optimizedPath.push(L.latLng(nextStop.lat, nextStop.lng));
            
            // ThÃªm vÃ o danh sÃ¡ch hiá»ƒn thá»‹ HTML
            htmlList += `
                <div style="padding: 10px; border-left: 3px solid #5e72e4; background: #f8f9fe; margin-bottom: 10px;">
                    <b style="color:#333;">${optimizedPath.length - 1}. ${nextStop.name}</b><br>
                    <small>${nextStop.address}</small>
                </div>
            `;

            // Cáº­p nháº­t Ä‘iá»ƒm hiá»‡n táº¡i lÃ  Ä‘iá»ƒm vá»«a Ä‘áº¿n
            currentLocation = nextStop;
            // XÃ³a khá»i danh sÃ¡ch chÆ°a Ä‘i
            unvisited.splice(nearestIndex, 1);
        }

        // Cáº­p nháº­t giao diá»‡n bÃªn trÃ¡i
        document.getElementById('route-list').innerHTML = htmlList + `<div style="text-align:center; color:green; font-weight:bold;">ğŸ HOÃ€N THÃ€NH Lá»˜ TRÃŒNH</div>`;

        // --- Váº¼ ÄÆ¯á»œNG ÄI Ná»I CÃC ÄIá»‚M ---
        if (routingControl) map.removeControl(routingControl); // XÃ³a Ä‘Æ°á»ng cÅ© náº¿u cÃ³

        routingControl = L.Routing.control({
            waypoints: optimizedPath,
            routeWhileDragging: false,
            show: false, // Táº¯t báº£ng chá»‰ dáº«n máº·c Ä‘á»‹nh (vÃ¬ mÃ¬nh tá»± lÃ m bÃªn trÃ¡i rá»“i)
            createMarker: function(i, wp, nWps) {
                if (i === 0) return null; // ÄÃ£ váº½ kho rá»“i
                // TÃ¬m thÃ´ng tin khÃ¡ch dá»±a trÃªn tá»a Ä‘á»™
                return L.marker(wp.latLng, {icon: customerIcon}).bindPopup(`Äiá»ƒm dá»«ng thá»© ${i}`);
            }
        }).addTo(map);
    }
</script>
{% endblock %}